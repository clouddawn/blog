# Vue2 响应式原理

Vue2 响应式原理通过 `Object.defineProperty` 对对象属性做 `getter/setter` 拦截，实现数据劫持；每个属性都有一个 Dep 管理依赖，组件渲染时创建 Watcher，访问数据时收集依赖，数据修改时触发 Dep 通知 Watcher 更新视图。数组通过重写变异方法实现响应式。

## 概念

* 响应式系统是 Vue2 核心特性之一，用于实现数据变化自动更新视图。
* 核心技术是数据劫持 + 发布-订阅模式。

## 核心组成

### Observer

* 对对象或数组进行遍历和拦截
* 对每个属性调用 `Object.defineProperty` 定义 `getter/setter`。
* 当属性被访问时收集依赖，当属性被修改时触发视图更新。

```js
function defineReactive(obj, key, value){
    const dep = new Dep(); // 依赖管理器
    Object.defineProperty(obj, key, {
        get(){
            dep.depend(); // 收集依赖
            return val;
        }, 
        set(newVal){
            val = newVal;
            dep.notify(); // 通知依赖更新
        }
    })
}
```

### Dep（依赖收集器）

* 每个响应式属性都有一个 Dep 实例，用于管理依赖（Watcher）。
* 当属性被访问时，Dep 收集当前 Watcher 作为依赖。
* 当属性更新时，Dep 通知所有 Watcher 执行更新。

### Watcher（订阅者）

* 每个组件或计算属性对应一个 Watcher。
* Watcher 会在渲染时访问响应式数据，从而被 Dep 收集。
* 数据变化时，Dep 通知 Watcher 更新视图或重新计算。

### 数组响应式

* Vue2 不能直接拦截数组索引或长度变化。
* 通过重写数组变异方法（push、pop、splice等）来触发视图更新。

```js
['push', 'pop', 'splice'].forEach(method => {
    const original = Array.prototype[method];
    Array.prototype[method] = function(...args){
        const result = original.apply(this, args);
        // 通知依赖更新
        dep.notify();
        return result;
    }
})
```

### 响应式数据流总结

* 组件渲染  ====>  创建 Watcher
* 访问数据  ====>  getter 被触发  ====>  收集依赖到 Dep
* 数据修改  ====>  setter 被触发  ====>  Dep 通知对应 Watcher
* Watcher 更新  ====>  重新渲染组件

核心思想：数据变化  ====>  通知订阅者  ====>  视图更新。

























